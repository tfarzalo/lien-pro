# E-Commerce Flow Diagrams

## Test Mode Flow (Current Implementation)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    User      â”‚
â”‚   Visits     â”‚
â”‚  /assessment â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Interactive Assessment Page     â”‚
â”‚  - Answers questions             â”‚
â”‚  - System calculates urgency     â”‚
â”‚  - Generates recommendations     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Assessment Summary Component   â”‚
â”‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Recommended Kits           â”‚ â”‚
â”‚  â”‚ â€¢ Basic Lien Kit - $99    â”‚ â”‚
â”‚  â”‚   [Purchase Kit] button    â”‚ â”‚
â”‚  â”‚                            â”‚ â”‚
â”‚  â”‚ â€¢ Premium Kit - $199       â”‚ â”‚
â”‚  â”‚   [Purchase Kit] button    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                  â”‚
â”‚  [Purchase All Kits] button      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Click "Purchase Kit"
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Checkout Page                  â”‚
â”‚   /checkout?kit=xxx              â”‚
â”‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Order Summary              â”‚ â”‚
â”‚  â”‚ â€¢ Basic Lien Kit - $99.00  â”‚ â”‚
â”‚  â”‚   âœ“ Preliminary Notice     â”‚ â”‚
â”‚  â”‚   âœ“ Affidavit Forms        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Payment Information        â”‚ â”‚
â”‚  â”‚ Card: 4242 4242 4242 4242  â”‚ â”‚
â”‚  â”‚ Exp: 12/2030               â”‚ â”‚
â”‚  â”‚ CVC: 123                   â”‚ â”‚
â”‚  â”‚ Name: Test User            â”‚ â”‚
â”‚  â”‚ Email: test@example.com    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                  â”‚
â”‚  [ğŸ”’ Complete Purchase] button   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Click "Complete Purchase"
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  processTestPayment()            â”‚
â”‚  (stripeService.ts)              â”‚
â”‚                                  â”‚
â”‚  1. Get kit details from DB      â”‚
â”‚  2. Generate order number        â”‚
â”‚  3. CREATE order record          â”‚
â”‚     â€¢ status: 'completed'        â”‚
â”‚     â€¢ total_cents: 9900          â”‚
â”‚  4. CREATE order_items           â”‚
â”‚  5. CREATE user_kits (access)    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Order Success Page             â”‚
â”‚   /checkout/success?order=xxx    â”‚
â”‚                                  â”‚
â”‚  âœ… Payment Successful!          â”‚
â”‚                                  â”‚
â”‚  Order #: TEST-1699901234-ABC    â”‚
â”‚  Date: November 14, 2025         â”‚
â”‚  Total: $99.00                   â”‚
â”‚                                  â”‚
â”‚  Purchased Items:                â”‚
â”‚  â€¢ Basic Lien Kit - $99.00       â”‚
â”‚                                  â”‚
â”‚  What's Next?                    â”‚
â”‚  1. Access your kits             â”‚
â”‚  2. Download forms               â”‚
â”‚  3. Get support                  â”‚
â”‚                                  â”‚
â”‚  [Go to Dashboard] button        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Dashboard                      â”‚
â”‚                                  â”‚
â”‚  My Purchased Kits:              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ âœ… Basic Lien Kit          â”‚ â”‚
â”‚  â”‚ Purchased: Nov 14, 2025    â”‚ â”‚
â”‚  â”‚ [View Forms] button        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Production Flow (Ready to Enable)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    User      â”‚
â”‚   Visits     â”‚
â”‚  /assessment â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Assessment â†’ Recommendations     â”‚
â”‚  (Same as test mode)             â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Checkout Page                  â”‚
â”‚   /checkout?kit=xxx              â”‚
â”‚                                  â”‚
â”‚  [Complete Purchase] clicked     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Call createCheckoutSession()
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend API Call               â”‚
â”‚  POST /functions/v1/             â”‚
â”‚       create-checkout-session    â”‚
â”‚                                  â”‚
â”‚  Body: {                         â”‚
â”‚    kitIds: ["uuid"],             â”‚
â”‚    successUrl: "...",            â”‚
â”‚    cancelUrl: "...",             â”‚
â”‚    metadata: {                   â”‚
â”‚      userId: "uuid",             â”‚
â”‚      orderNumber: "ORD-123"      â”‚
â”‚    }                             â”‚
â”‚  }                               â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Supabase Edge Function          â”‚
â”‚  create-checkout-session         â”‚
â”‚                                  â”‚
â”‚  1. Fetch kit details from DB    â”‚
â”‚  2. Build line items             â”‚
â”‚  3. Call Stripe API:             â”‚
â”‚     stripe.checkout.sessions     â”‚
â”‚            .create()             â”‚
â”‚  4. Return session URL           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Response to Frontend            â”‚
â”‚  {                               â”‚
â”‚    sessionId: "cs_test_...",     â”‚
â”‚    url: "https://checkout..."    â”‚
â”‚  }                               â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Redirect to Stripe Checkout     â”‚
â”‚  window.location.href = url      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”· Stripe Checkout Page ğŸ”·     â”‚
â”‚  (Hosted by Stripe)              â”‚
â”‚                                  â”‚
â”‚  â€¢ Secure payment form           â”‚
â”‚  â€¢ Card validation               â”‚
â”‚  â€¢ 3D Secure if needed           â”‚
â”‚  â€¢ PCI compliant                 â”‚
â”‚                                  â”‚
â”‚  User enters real card details   â”‚
â”‚  and completes payment           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â–º Payment Success
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Stripe Sends Webhook Event      â”‚
â”‚  POST /functions/v1/             â”‚
â”‚       stripe-webhook             â”‚
â”‚                                  â”‚
â”‚  Event: checkout.session.completed
â”‚  Signature: stripe-signature     â”‚
â”‚  Body: { session data... }       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Supabase Edge Function          â”‚
â”‚  stripe-webhook                  â”‚
â”‚                                  â”‚
â”‚  1. Verify signature âœ“           â”‚
â”‚  2. Extract metadata             â”‚
â”‚  3. Fetch kit details            â”‚
â”‚  4. CREATE order                 â”‚
â”‚  5. CREATE order_items           â”‚
â”‚  6. CREATE user_kits (access)    â”‚
â”‚  7. Return { received: true }    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ (Parallel: User redirected)
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Stripe Redirects User           â”‚
â”‚  to Success URL                  â”‚
â”‚  /checkout/success?              â”‚
â”‚    session_id=cs_test_...        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Order Success Page              â”‚
â”‚  Fetches order by session_id     â”‚
â”‚  Displays confirmation           â”‚
â”‚  Links to dashboard              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Database Operations Flow

```
processTestPayment() or Webhook Handler
         â”‚
         â”œâ”€â–º Step 1: Fetch Kits
         â”‚   SELECT * FROM lien_kits
         â”‚   WHERE id IN (kit_ids)
         â”‚   
         â”œâ”€â–º Step 2: Create Order
         â”‚   INSERT INTO orders
         â”‚   (user_id, order_number, total_cents,
         â”‚    status, payment_method, stripe_session_id,
         â”‚    paid_at, payment_metadata)
         â”‚   VALUES (...)
         â”‚   RETURNING *
         â”‚   
         â”œâ”€â–º Step 3: Create Order Items
         â”‚   INSERT INTO order_items
         â”‚   (order_id, lien_kit_id, quantity,
         â”‚    unit_price_cents, total_price_cents,
         â”‚    kit_name, kit_features)
         â”‚   VALUES (...)
         â”‚   
         â””â”€â–º Step 4: Grant Kit Access
             INSERT INTO user_kits
             (user_id, lien_kit_id, access_type,
              purchase_date)
             VALUES (...)
             
Result:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  orders                     â”‚
â”‚  â”œâ”€ id: uuid                â”‚
â”‚  â”œâ”€ user_id: uuid           â”‚
â”‚  â”œâ”€ order_number: "ORD-..."â”‚
â”‚  â”œâ”€ total_cents: 9900       â”‚
â”‚  â”œâ”€ status: "completed"     â”‚
â”‚  â””â”€ paid_at: timestamp      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”œâ”€â–º order_items (1:N)
            â”‚   â”œâ”€ order_id: uuid
            â”‚   â”œâ”€ lien_kit_id: uuid
            â”‚   â”œâ”€ unit_price_cents: 9900
            â”‚   â”œâ”€ kit_name: "Basic Kit"
            â”‚   â””â”€ kit_features: [...]
            â”‚
            â””â”€â–º user_kits (via user_id)
                â”œâ”€ user_id: uuid
                â”œâ”€ lien_kit_id: uuid
                â”œâ”€ access_type: "purchased"
                â””â”€ purchase_date: timestamp
```

## Component Interaction Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Frontend Layer                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â–º InteractiveAssessmentPage.tsx
         â”‚   â””â”€â–º AssessmentSummary.tsx
         â”‚       â””â”€â–º handlePurchaseKit(kitId)
         â”‚           navigate(`/checkout?kit=${kitId}`)
         â”‚
         â”œâ”€â–º CheckoutPage.tsx
         â”‚   â”œâ”€ useSearchParams() â†’ get kit IDs
         â”‚   â”œâ”€ useLienKits() â†’ fetch kit details
         â”‚   â”œâ”€ useProcessTestPayment() â†’ test mode
         â”‚   â””â”€ useCreateCheckoutSession() â†’ production
         â”‚
         â””â”€â–º OrderSuccessPage.tsx
             â”œâ”€ useSearchParams() â†’ get order ID
             â””â”€ useOrderDetails(orderId) â†’ fetch order

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Hooks Layer                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â–º useCheckout.ts (React Query)
         â”‚   â”œâ”€ useCreateCheckoutSession()
         â”‚   â”œâ”€ useProcessTestPayment()
         â”‚   â””â”€ useOrderDetails()
         â”‚
         â””â”€â–º Calls â–¼

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Services Layer                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â””â”€â–º stripeService.ts
             â”œâ”€ createCheckoutSession()
             â”‚  â””â”€ POST /functions/v1/create-checkout-session
             â”‚
             â”œâ”€ processTestPayment()
             â”‚  â””â”€ Direct Supabase calls
             â”‚
             â””â”€ getOrderDetails()
                â””â”€ Supabase query with joins

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Backend Layer                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â–º Supabase Edge Functions
         â”‚   â”œâ”€ create-checkout-session/index.ts
         â”‚   â”‚  â””â”€ Calls Stripe API
         â”‚   â”‚
         â”‚   â””â”€ stripe-webhook/index.ts
         â”‚      â””â”€ Handles Stripe events
         â”‚
         â””â”€â–º Supabase Database
             â”œâ”€ lien_kits (with stripe IDs)
             â”œâ”€ orders (with stripe session)
             â”œâ”€ order_items (snapshots)
             â””â”€ user_kits (access control)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   External Services                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â””â”€â–º Stripe
             â”œâ”€ Checkout Sessions API
             â”œâ”€ Hosted Checkout Page
             â””â”€ Webhooks
```

## State Management Flow

```
Assessment Store (Zustand)
â”œâ”€ assessmentId
â”œâ”€ currentStep
â”œâ”€ currentQuestionIndex
â”œâ”€ answers: Map<string, any>
â”œâ”€ result: AssessmentResult
â”‚  â”œâ”€ urgencyLevel
â”‚  â”œâ”€ deadlines[]
â”‚  â””â”€ recommendedKits[]
â”‚     â”œâ”€ kit: LienKit
â”‚     â”œâ”€ reason: string
â”‚     â”œâ”€ priority: "primary" | "secondary"
â”‚     â””â”€ matchScore: number
â”‚
â””â”€â–º User clicks "Purchase Kit"
    â””â”€â–º Navigate to Checkout

Checkout Page State (React Local State)
â”œâ”€ selectedKitIds: string[]
â”œâ”€ checkoutItems: CheckoutItem[]
â”œâ”€ paymentDetails: TestPaymentDetails
â”œâ”€ isProcessing: boolean
â””â”€ error: string

React Query Cache
â”œâ”€ ['lien-kits'] â†’ All available kits
â”œâ”€ ['orders'] â†’ User's orders
â”œâ”€ ['order', orderId] â†’ Specific order
â””â”€ ['user-kits'] â†’ User's purchased kits
```

## Error Handling Flow

```
                 User Action
                     â”‚
                     â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Try Operation  â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                       â”‚
    âœ… Success                âŒ Error
         â”‚                       â”‚
         â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Show Success    â”‚    â”‚ Catch Error     â”‚
â”‚ - Toast         â”‚    â”‚ - Log to consoleâ”‚
â”‚ - Navigate      â”‚    â”‚ - Set error msg â”‚
â”‚ - Update cache  â”‚    â”‚ - Show Alert    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚ User sees:      â”‚
                       â”‚ â€¢ Error message â”‚
                       â”‚ â€¢ Retry option  â”‚
                       â”‚ â€¢ Support link  â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
